function storageOperation(e){return localforage.getItem("version").then(t=>t&&t===e?(console.log("当前是最新版本"),!1):localforage.setItem("version",e).then(()=>(console.log(`版本已更新到：${e}`),!0))).catch(e=>{throw console.error("获取或设置版本信息时出现错误:",e),e})}function checkUpdate(e){const t=e["dist-tags"].latest;storageOperation(t).then(e=>{e?console.log("博客缓存版本已更新"):console.log(`当前版本: ${t} 是最新的`)}).catch(e=>{console.error("更新检查失败:",e)})}function getNewestData(){const e=`${NPM_REGISTRY_BASE_URL}${packageName}`;self.fetch(e).then(e=>e.json()).then(e=>checkUpdate(e)).catch(e=>console.error("Fetch 更新信息失败:",e))}function fetchNewestDataIfNeeded(){isDataFetched||(getNewestData(),isDataFetched=!0)}function corsResponse(e){const t=new Headers(e.headers);return t.set("Access-Control-Allow-Origin","*"),t.set("Access-Control-Allow-Methods","GET, HEAD, POST, OPTIONS"),t.set("Access-Control-Allow-Headers","Content-Type"),new Response(e.body,{status:e.status,headers:t})}self.importScripts("/js/localforage.min.js");let blogVersion="",checkJson={},isDataFetched=!1;const NPM_REGISTRY_BASE_URL="https://registry.npmmirror.com/",packageName="fsl-blog",blogDomain="blog.hesiy.cn",localMode=!1;self.addEventListener("install",e=>{self.skipWaiting()}),self.addEventListener("activate",e=>{e.waitUntil(self.clients.claim().then(()=>{fetchNewestDataIfNeeded()}))}),self.addEventListener("fetch",e=>{fetchNewestDataIfNeeded();const t=new URL(e.request.url),s="text/event-stream"===e.request.headers.get("Accept");if(s)return;const o=localMode||t.hostname===blogDomain,n=o&&e.request.url.startsWith(self.location.origin)&&!e.request.url.includes("sw.js");if(!n)return fetch(e.request);{let s=t.pathname;s.endsWith("/")&&(s+="index.html"),localforage.getItem("version").then(e=>{e?blogVersion=e:getNewestData()}).catch(e=>{console.error("获取版本信息失败:",e)});const o=`${NPM_REGISTRY_BASE_URL}${packageName}/${blogVersion}/files${s}`;e.respondWith(fetch(o).then(e=>{if(!e.ok)throw new Error("NPM Mirror 响应出现问题：范围脱离 200 ~ 299");return corsResponse(e)}).catch(t=>(console.log("从 NPM Mirror 获取数据失败，退回到原请求：",t.message),fetch(e.request))))}}),self.addEventListener("terminate",e=>{isDataFetched=!1}),self.addEventListener("message",e=>{e.data&&"force-refresh"===e.data.action&&self.registration.update().then(()=>{localforage.removeItem("version").then(function(){console.log("版本缓存清除")}).catch(function(e){console.log(e)}),caches.keys().then(e=>Promise.all(e.map(e=>caches.delete(e)))).then(()=>{self.clients.matchAll().then(e=>{e.forEach(e=>e.postMessage("sw-updated"))})})})});